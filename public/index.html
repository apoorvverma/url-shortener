<!doctype html>
<html>
  <head>
    <title>URL Shortener | Home</title>
    <script>
      function getUrls() {
        document.getElementById('urls').innerHTML = '';
        const deviceId = document.getElementById('deviceId').value;

        fetch('/urls', { method: 'GET' })
          .then((response) => response.json())
          .then((data) => {
            if (!Array.isArray(data) || data.length === 0) {
              document.getElementById('urls').innerHTML = 'No shortened URLs exist yet.';
              return;
            }

            const container = document.getElementById('urls');
            
            for (const url of data) {
                const link = document.createElement('a');
                
                const origin = window.location.origin;
                link.href = `${origin}/${url.short_code}?deviceId=${deviceId}`;

                link.target = "_blank";
                link.className = "hoverable";

                link.style.cssText = "text-decoration: none; color: black; margin: 10px; padding: 20px; background-color: #fff; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); display: flex; justify-content: space-between; align-items: center;";

                const shortSpan = document.createElement('span');
                shortSpan.textContent = `${origin}/${url.short_code}`;

                const originalSpan = document.createElement('span');
                originalSpan.style.cssText = "color: lightgray; font-size: 14px; margin-left: 16px;";
                originalSpan.textContent = url.url;

                link.appendChild(shortSpan);
                link.appendChild(originalSpan);
                container.appendChild(link);
            }
          })
          .catch((err) => {
            document.getElementById('error').textContent = err.message || 'Failed to load URLs';
          });
      }

      function shortenUrl() {
        const url = document.getElementById('url').value;
        const origin = window.location.origin;
        fetch('/shorten', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
        })
          .then(async (response) => {
            const data = await response.json().catch(() => null);
            if (!response.ok) {
              const msg = data && data.error ? data.error : 'Failed to shorten URL';
              throw new Error(msg);
            }
            const shortUrl = (data && data.shortUrl) ? data.shortUrl : `${origin}/${data.shortCode}`;
            document.getElementById('result').textContent = shortUrl;
            document.getElementById('error').textContent = '';
            getUrls();
          })
          .catch((error) => {
            document.getElementById('result').textContent = '';
            document.getElementById('error').textContent = error.message || 'Failed to shorten URL';
          });
      }
    </script>
    <style>
      .hoverable:hover { transform: scale(1.01); }
      body { background-color: #f0f0f0; font-family: system-ui, sans-serif; max-width: 1000px; margin: 0 auto; text-align: center; }
      #urls { margin-top: 20px; display: flex; flex-direction: column; }
    </style>
  </head>
  <body>
    <h1>Enter a URL to shorten:</h1>
    <input id="url" name="url" placeholder="https://example.com" />
    <button onclick="shortenUrl()">Shorten</button>
    <p id="result" style="color: darkgreen;"></p>
    <p id="error" style="color: darkred;"></p>
    <div id="urls"></div>
    <input type="hidden" id="deviceId" name="deviceId" value="" />

    <script>
      document.getElementById('deviceId').value = Math.random().toString(36).substring(2, 8);
      getUrls();
    </script>
  </body>
</html>
